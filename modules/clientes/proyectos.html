<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Proyectos - AXSOL DaaS</title>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/styles.css">
</head>
<body>
    <!-- Incluir header -->
    <div id="header-container"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Incluir sidebar -->
            <div id="sidebar-container" class="col-md-3 col-lg-2 d-md-block sidebar"></div>

            <!-- Contenido principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="page-title">Gestión de Proyectos</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="proyecto-form.html" id="new-project-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nuevo Proyecto
                        </a>
                    </div>
                </div>

                <!-- Contenedor de alertas -->
                <div id="alertsContainer"></div>

                <!-- Cliente seleccionado (si aplica) -->
                <div id="cliente-info" class="card mb-4 d-none">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Cliente</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-3">Nombre:</dt>
                                    <dd class="col-sm-9" id="cliente-nombre">-</dd>
                                    <dt class="col-sm-3">Contacto:</dt>
                                    <dd class="col-sm-9" id="cliente-contacto">-</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-3">Email:</dt>
                                    <dd class="col-sm-9" id="cliente-email">-</dd>
                                    <dt class="col-sm-3">Estado:</dt>
                                    <dd class="col-sm-9" id="cliente-estado">-</dd>
                                </dl>
                            </div>
                        </div>
                        <div class="text-end">
                            <a href="clientes.html" class="btn btn-secondary btn-sm">Volver a Clientes</a>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Filtros</h5>
                    </div>
                    <div class="card-body">
                        <form id="search-form" class="row g-3">
                            <div class="col-md-4">
                                <label for="filtroNombre" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="filtroNombre" placeholder="Buscar por nombre...">
                            </div>
                            <div class="col-md-4" id="filtroCliente-container">
                                <label for="filtroCliente" class="form-label">Cliente</label>
                                <select class="form-select" id="filtroCliente">
                                    <option value="">Todos</option>
                                    <!-- Opciones cargadas dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filtroEstado" class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos</option>
                                    <option value="En Progreso">En Progreso</option>
                                    <option value="Planificación">Planificación</option>
                                    <option value="Completado">Completado</option>
                                    <option value="Cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="col-12 d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary me-2">Filtrar</button>
                                <button type="reset" class="btn btn-secondary">Limpiar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tabla de proyectos -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0" id="table-title">Listado de Proyectos</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Cliente</th>
                                        <th>Ubicación</th>
                                        <th>Fecha Inicio</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="proyectosTableBody">
                                    <!-- Los datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <nav>
                            <ul class="pagination justify-content-center mb-0" id="pagination">
                                <!-- La paginación se generará dinámicamente -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Incluir footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script>
        // Variables globales
        let currentPage = 1;
        const itemsPerPage = 10;
        let selectedClienteId = null;

        // Cargar componentes
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar componentes HTML
            fetch('../../components/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                });

            fetch('/components/sidebar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                });

            fetch('/components/footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                });

            // Verificar si hay un cliente seleccionado
            selectedClienteId = Utils.getUrlParam('clienteId');
            if (selectedClienteId) {
                // Mostrar info del cliente y cargar sus proyectos
                showClienteInfo(selectedClienteId);
                
                // Actualizar botón de nuevo proyecto
                document.getElementById('new-project-btn').href = `proyecto-form.html?clienteId=${selectedClienteId}`;
                
                // Ocultar selector de cliente en filtros
                document.getElementById('filtroCliente-container').classList.add('d-none');
                
                // Actualizar títulos
                document.getElementById('table-title').textContent = 'Proyectos del Cliente';
            } else {
                // Cargar todos los clientes para el selector
                loadClientesSelect();
            }

            // Cargar datos de proyectos
            loadProyectos();

            // Configurar eventos
            document.getElementById('search-form').addEventListener('submit', function(e) {
                e.preventDefault();
                filterProyectos();
            });

            document.getElementById('search-form').addEventListener('reset', function(e) {
                setTimeout(loadProyectos, 0);
            });
        });

        // Mostrar información del cliente seleccionado
        function showClienteInfo(clienteId) {
            const cliente = DataService.getById('clientes', clienteId);
            if (!cliente) {
                Utils.showNotification('Cliente no encontrado', 'danger');
                setTimeout(() => Utils.redirect('clientes.html'), 2000);
                return;
            }

            // Mostrar el panel de info del cliente
            document.getElementById('cliente-info').classList.remove('d-none');
            
            // Actualizar información
            document.getElementById('cliente-nombre').textContent = cliente.nombre;
            document.getElementById('cliente-contacto').textContent = cliente.contacto;
            document.getElementById('cliente-email').textContent = cliente.email;
            document.getElementById('cliente-estado').textContent = cliente.estado;
            
            // Actualizar título de la página
            document.getElementById('page-title').textContent = `Proyectos de ${cliente.nombre}`;
        }

        // Cargar clientes para el selector
        function loadClientesSelect() {
            const clientes = DataService.getAll('clientes');
            const select = document.getElementById('filtroCliente');
            
            // Mantener la opción "Todos"
            select.innerHTML = '<option value="">Todos</option>';
            
            // Agregar opciones de clientes
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = cliente.nombre;
                select.appendChild(option);
            });
        }

        // Cargar proyectos
        function loadProyectos() {
            let proyectos = DataService.getAll('proyectos');
            
            // Filtrar por cliente seleccionado si es necesario
            if (selectedClienteId) {
                proyectos = proyectos.filter(proyecto => 
                    proyecto.clienteId === parseInt(selectedClienteId)
                );
            }
            
            renderProyectos(proyectos);
        }

        // Filtrar proyectos
        function filterProyectos() {
            const nombreFilter = document.getElementById('filtroNombre').value;
            const estadoFilter = document.getElementById('filtroEstado').value;
            let clienteFilter = selectedClienteId || '';
            
            // Si no hay cliente seleccionado, obtener del filtro
            if (!selectedClienteId) {
                clienteFilter = document.getElementById('filtroCliente').value;
            }
            
            let proyectos = DataService.getAll('proyectos');
            
            // Aplicar filtros
            if (nombreFilter) {
                proyectos = proyectos.filter(proyecto => 
                    proyecto.nombre.toLowerCase().includes(nombreFilter.toLowerCase())
                );
            }
            
            if (estadoFilter) {
                proyectos = proyectos.filter(proyecto => 
                    proyecto.estado === estadoFilter
                );
            }
            
            if (clienteFilter) {
                proyectos = proyectos.filter(proyecto => 
                    proyecto.clienteId === parseInt(clienteFilter)
                );
            }
            
            renderProyectos(proyectos);
        }

        // Renderizar proyectos en la tabla
        function renderProyectos(proyectos) {
            const tbody = document.getElementById('proyectosTableBody');
            tbody.innerHTML = '';
            
            if (proyectos.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="7" class="text-center">No se encontraron proyectos</td>';
                tbody.appendChild(tr);
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // Cargar clientes para mostrar nombres
            const clientes = DataService.getAll('clientes');
            const clientesMap = {};
            clientes.forEach(cliente => {
                clientesMap[cliente.id] = cliente.nombre;
            });
            
            // Paginación
            const totalPages = Math.ceil(proyectos.length / itemsPerPage);
            if (currentPage > totalPages) {
                currentPage = 1;
            }
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedProyectos = proyectos.slice(start, end);
            
            // Renderizar proyectos paginados
            paginatedProyectos.forEach(proyecto => {
                const tr = document.createElement('tr');
                
                // Obtener nombre del cliente
                const clienteNombre = clientesMap[proyecto.clienteId] || `Cliente ID: ${proyecto.clienteId}`;
                
                // Determinar clase para el estado
                let estadoClass = '';
                switch (proyecto.estado) {
                    case 'En Progreso':
                        estadoClass = 'bg-primary';
                        break;
                    case 'Planificación':
                        estadoClass = 'bg-info';
                        break;
                    case 'Completado':
                        estadoClass = 'bg-success';
                        break;
                    case 'Cancelado':
                        estadoClass = 'bg-danger';
                        break;
                    default:
                        estadoClass = 'bg-secondary';
                }
                
                tr.innerHTML = `
                    <td>${proyecto.id}</td>
                    <td>${proyecto.nombre}</td>
                    <td>${clienteNombre}</td>
                    <td>${proyecto.ubicacion}</td>
                    <td>${Utils.formatDate(proyecto.fechaInicio)}</td>
                    <td><span class="badge ${estadoClass}">${proyecto.estado}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="proyecto-form.html?id=${proyecto.id}" class="btn btn-warning" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-danger" title="Eliminar" onclick="deleteProyecto(${proyecto.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Actualizar paginación
            renderPagination(totalPages);
        }

        // Renderizar controles de paginación
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            pagination.appendChild(prevLi);
            
            // Páginas
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // Cambiar página
        function changePage(page) {
            if (page < 1) return;
            currentPage = page;
            filterProyectos();
        }

        // Eliminar proyecto
        async function deleteProyecto(id) {
            const confirmed = await Utils.confirm('¿Está seguro de eliminar este proyecto? Esta acción no se puede deshacer.');
            if (!confirmed) return;
            
            const success = DataService.delete('proyectos', id);
            if (success) {
                Utils.showNotification('Proyecto eliminado correctamente', 'success');
                loadProyectos();
            } else {
                Utils.showNotification('Error al eliminar el proyecto', 'danger');
            }
        }
    </script>
</body>
</html>