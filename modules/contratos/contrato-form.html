<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXSOL DaaS - Formulario de Contrato</title>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- DatePicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-container"></div>
            
            <!-- Contenido principal -->
            <main class="col px-0 flex-grow-1">
                <div id="header-container"></div>
                
                <div class="container-fluid py-4">
                    <div class="row justify-content-center">
                        <div class="col-12 col-lg-10">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0" id="formTitle">Nuevo Contrato</h5>
                                </div>
                                <div class="card-body">
                                    <form id="contratoForm" class="needs-validation" novalidate>
                                        <input type="hidden" id="contratoId">
                                        
                                        <div class="row mb-3">
                                            <!-- Cliente -->
                                            <div class="col-md-6 mb-3">
                                                <label for="clienteId" class="form-label">Cliente</label>
                                                <select class="form-select" id="clienteId" required>
                                                    <option value="">Seleccionar cliente</option>
                                                    <!-- Se cargará dinámicamente -->
                                                </select>
                                                <div class="invalid-feedback">
                                                    Por favor seleccione un cliente.
                                                </div>
                                            </div>
                                            
                                            <!-- Proyecto -->
                                            <div class="col-md-6 mb-3">
                                                <label for="proyectoId" class="form-label">Proyecto</label>
                                                <select class="form-select" id="proyectoId" required>
                                                    <option value="">Seleccione primero un cliente</option>
                                                    <!-- Se cargará dinámicamente -->
                                                </select>
                                                <div class="invalid-feedback">
                                                    Por favor seleccione un proyecto.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <!-- Fecha Inicio -->
                                            <div class="col-md-6 mb-3">
                                                <label for="fechaInicio" class="form-label">Fecha de Inicio</label>
                                                <input type="text" class="form-control flatpickr-date" id="fechaInicio" required>
                                                <div class="invalid-feedback">
                                                    Por favor seleccione una fecha de inicio.
                                                </div>
                                            </div>
                                            
                                            <!-- Fecha Fin -->
                                            <div class="col-md-6 mb-3">
                                                <label for="fechaFin" class="form-label">Fecha de Fin</label>
                                                <input type="text" class="form-control flatpickr-date" id="fechaFin" required>
                                                <div class="invalid-feedback">
                                                    Por favor seleccione una fecha de fin.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <!-- Tipo Servicio -->
                                            <div class="col-md-6 mb-3">
                                                <label for="tipoServicio" class="form-label">Tipo de Servicio</label>
                                                <select class="form-select" id="tipoServicio" required>
                                                    <option value="">Seleccionar tipo de servicio</option>
                                                    <option value="Inspección Drones">Inspección Drones</option>
                                                    <option value="Análisis de Datos">Análisis de Datos</option>
                                                    <option value="Mantenimiento">Mantenimiento</option>
                                                    <option value="Consultoría">Consultoría</option>
                                                    <option value="Otro">Otro</option>
                                                </select>
                                                <div class="invalid-feedback">
                                                    Por favor seleccione un tipo de servicio.
                                                </div>
                                            </div>
                                            
                                            <!-- Frecuencia -->
                                            <div class="col-md-6 mb-3">
                                                <label for="frecuencia" class="form-label">Frecuencia</label>
                                                <select class="form-select" id="frecuencia" required>
                                                    <option value="">Seleccionar frecuencia</option>
                                                    <option value="Única">Única</option>
                                                    <option value="Diaria">Diaria</option>
                                                    <option value="Semanal">Semanal</option>
                                                    <option value="Mensual">Mensual</option>
                                                    <option value="Trimestral">Trimestral</option>
                                                    <option value="Anual">Anual</option>
                                                </select>
                                                <div class="invalid-feedback">
                                                    Por favor seleccione una frecuencia.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tarifas -->
                                        <div class="mb-4">
                                            <label for="tarifas" class="form-label">Tarifas</label>
                                            <select class="form-select select2-multiple" id="tarifas" multiple="multiple" required>
                                                <option value="Tarifa Básica">Tarifa Básica</option>
                                                <option value="Tarifa Estándar">Tarifa Estándar</option>
                                                <option value="Tarifa Premium">Tarifa Premium</option>
                                                <option value="Tarifa Empresarial">Tarifa Empresarial</option>
                                                <option value="Tarifa Personalizada">Tarifa Personalizada</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione al menos una tarifa.
                                            </div>
                                            <div class="form-text">
                                                Puede seleccionar múltiples tarifas.
                                            </div>
                                        </div>
                                        
                                        <!-- Botones de acción -->
                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-secondary" onclick="window.location.href='contratos.html'">
                                                <i class="bi bi-x-circle me-1"></i> Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-save me-1"></i> Guardar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../../assets/js/bootstrap.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/mock-data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // Cargar componentes
        document.addEventListener("DOMContentLoaded", function() {
            // Cargar sidebar y header
            fetch('../../components/sidebar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    // Activar item del menú
                    const menuItem = document.querySelector('#sidebar-contratos');
                    if (menuItem) menuItem.classList.add('active');
                });
            
            fetch('../../components/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                });
            
            // Inicializar flatpickr para fechas
            flatpickr(".flatpickr-date", {
                dateFormat: "Y-m-d",
                allowInput: true
            });
            
            // Inicializar select2 para selección múltiple
            $(document).ready(function() {
                $('.select2-multiple').select2({
                    placeholder: "Seleccione las tarifas aplicables",
                    allowClear: true
                });
            });
            
            // Cargar datos iniciales
            cargarClientes();
            comprobarEdicion();
            
            // Enlazar eventos
            document.getElementById('clienteId').addEventListener('change', cargarProyectosPorCliente);
            document.getElementById('contratoForm').addEventListener('submit', guardarContrato);
        });
        
        // Función para cargar clientes
        function cargarClientes() {
            fetch('../../data/clientes.json')
                .then(response => response.json())
                .then(clientes => {
                    const selectCliente = document.getElementById('clienteId');
                    clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = cliente.nombre;
                        selectCliente.appendChild(option);
                    });
                })
                .catch(error => console.error('Error cargando clientes:', error));
        }
        
        // Función para cargar proyectos por cliente
        function cargarProyectosPorCliente() {
            const clienteId = parseInt(document.getElementById('clienteId').value);
            const selectProyecto = document.getElementById('proyectoId');
            
            // Limpiar proyectos actuales
            selectProyecto.innerHTML = '<option value="">Seleccionar proyecto</option>';
            
            if (!clienteId) return;
            
            fetch('../../data/proyectos.json')
                .then(response => response.json())
                .then(proyectos => {
                    // Filtrar proyectos del cliente seleccionado
                    const proyectosCliente = proyectos.filter(proyecto => proyecto.clienteId === clienteId);
                    
                    const selectProyecto = document.getElementById('proyectoId');
                    if (proyectosCliente.length === 0) {
                        selectProyecto.innerHTML = '<option value="">No hay proyectos para este cliente</option>';
                    } else {
                        proyectosCliente.forEach(proyecto => {
                            const option = document.createElement('option');
                            option.value = proyecto.id;
                            option.textContent = proyecto.nombre;
                            selectProyecto.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error cargando proyectos:', error));
        }
        
        // Comprobar si estamos en modo edición
        function comprobarEdicion() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            
            if (id) {
                // Estamos en modo edición
                document.getElementById('formTitle').textContent = 'Editar Contrato';
                document.getElementById('contratoId').value = id;
                
                // Cargar datos del contrato
                fetch('../../data/contratos.json')
                    .then(response => response.json())
                    .then(contratos => {
                        const contrato = contratos.find(c => c.id === parseInt(id));
                        if (!contrato) {
                            alert('Contrato no encontrado');
                            window.location.href = 'contratos.html';
                            return;
                        }
                        
                        // Completar el formulario con los datos
                        document.getElementById('clienteId').value = contrato.clienteId;
                        
                        // Cargar los proyectos y luego seleccionar el del contrato
                        cargarProyectosPorCliente();
                        setTimeout(() => {
                            document.getElementById('proyectoId').value = contrato.proyectoId;
                        }, 500); // Dar tiempo a que se carguen los proyectos
                        
                        document.getElementById('fechaInicio').value = contrato.fechaInicio;
                        document.getElementById('fechaFin').value = contrato.fechaFin;
                        document.getElementById('tipoServicio').value = contrato.tipoServicio;
                        document.getElementById('frecuencia').value = contrato.frecuencia;
                        
                        // Seleccionar las tarifas (usando select2)
                        $(document).ready(function() {
                            $('#tarifas').val(contrato.tarifas);
                            $('#tarifas').trigger('change');
                        });
                    })
                    .catch(error => console.error('Error cargando contrato:', error));
            }
        }
        
        // Guardar contrato
        function guardarContrato(event) {
            event.preventDefault();
            
            // Validar formulario
            const form = document.getElementById('contratoForm');
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // Obtener valores
            const id = document.getElementById('contratoId').value;
            const clienteId = parseInt(document.getElementById('clienteId').value);
            const proyectoId = parseInt(document.getElementById('proyectoId').value);
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const tipoServicio = document.getElementById('tipoServicio').value;
            const frecuencia = document.getElementById('frecuencia').value;
            const tarifas = $('#tarifas').val(); // Usando select2
            
            // Validar fechas
            if (new Date(fechaInicio) > new Date(fechaFin)) {
                alert('La fecha de inicio no puede ser posterior a la fecha de fin');
                return;
            }
            
            // Crear objeto de contrato
            const contrato = {
                clienteId,
                proyectoId,
                fechaInicio,
                fechaFin,
                tipoServicio,
                frecuencia,
                tarifas
            };
            
            // En un sistema real, esto sería una petición POST o PUT a la API
            // Para el mockup, simulamos con localStorage
            fetch('../../data/contratos.json')
                .then(response => response.json())
                .then(contratos => {
                    if (id) {
                        // Modo edición
                        const index = contratos.findIndex(c => c.id === parseInt(id));
                        if (index !== -1) {
                            // Mantener el ID original
                            contrato.id = parseInt(id);
                            contratos[index] = contrato;
                        }
                    } else {
                        // Modo creación
                        // Encontrar el ID más alto y agregar 1
                        const maxId = contratos.reduce((max, c) => (c.id > max ? c.id : max), 0);
                        contrato.id = maxId + 1;
                        contratos.push(contrato);
                    }
                    
                    // En un sistema real no haríamos esto, usaríamos una API
                    // Esto es solo para simular la persistencia en el frontend
                    localStorage.setItem('contratos', JSON.stringify(contratos));
                    
                    // Redirigir a la lista
                    window.location.href = 'contratos.html';
                })
                .catch(error => {
                    console.error('Error guardando contrato:', error);
                    alert('Ocurrió un error al guardar. Intente nuevamente.');
                });
        }
    </script>
</body>
</html>