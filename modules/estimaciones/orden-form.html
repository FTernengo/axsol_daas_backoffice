<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXSOL DaaS - Formulario de Orden de Venta</title>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <script src="../../assets/js/main.js" defer></script>
    <script src="../../assets/js/mock-data.js" defer></script>
    <script>
        let isEditMode = false;
        let currentOrdenId = null;
        let estimacionesData = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar componentes HTML
            loadComponent('header', '../../components/header.html');
            loadComponent('sidebar', '../../components/sidebar.html');
            loadComponent('footer', '../../components/footer.html');
            
            // Verificar si estamos en modo edición o si venimos de una estimación
            const urlParams = new URLSearchParams(window.location.search);
            const ordenId = urlParams.get('id');
            const estimacionId = urlParams.get('estimacionId');
            
            if (ordenId) {
                isEditMode = true;
                currentOrdenId = parseInt(ordenId);
                document.getElementById('form-title').textContent = 'Editar Orden de Venta';
                document.getElementById('submit-button').textContent = 'Actualizar Orden de Venta';
            }
            
            // Cargar datos de estimaciones para el selector
            loadEstimacionesData(estimacionId);
            
            // Configurar eventos
            setupFormEvents();
            
            // Configurar fecha actual para el periodo de liquidación
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('periodo-liquidacion').value = `${year}-${month}`;
        });
        
        // Función para cargar los datos de estimaciones
        function loadEstimacionesData(preselectedEstimacionId) {
            fetch('../../data/estimaciones.json')
                .then(response => response.json())
                .then(estimaciones => {
                    // Filtrar solo estimaciones aprobadas
                    estimacionesData = estimaciones.filter(e => e.estado === 'Aprobada');
                    populateEstimacionSelect(estimacionesData, preselectedEstimacionId);
                    
                    // Si estamos en modo edición, cargar datos de la orden
                    if (isEditMode) {
                        loadOrdenData(currentOrdenId);
                    } else if (preselectedEstimacionId) {
                        // Si venimos de una estimación, preseleccionarla
                        document.getElementById('estimacion-id').value = preselectedEstimacionId;
                        updateEstimacionInfo();
                    }
                })
                .catch(error => console.error('Error cargando estimaciones:', error));
        }
        
        // Función para poblar el selector de estimaciones
        function populateEstimacionSelect(estimaciones, preselectedEstimacionId) {
            const estimacionSelect = document.getElementById('estimacion-id');
            estimacionSelect.innerHTML = '<option value="">Seleccione una estimación...</option>';
            
            estimaciones.forEach(estimacion => {
                fetch('../../data/pedidos.json')
                    .then(response => response.json())
                    .then(pedidos => {
                        const pedido = pedidos.find(p => p.id === estimacion.pedidoId);
                        
                        const option = document.createElement('option');
                        option.value = estimacion.id;
                        option.textContent = `Estimación #${estimacion.id} - Pedido #${pedido ? pedido.id : 'N/A'} - Total: ${formatCurrency(estimacion.totalEstimado)}`;
                        estimacionSelect.appendChild(option);
                        
                        // Preseleccionar estimación si viene como parámetro
                        if (preselectedEstimacionId && parseInt(preselectedEstimacionId) === estimacion.id) {
                            estimacionSelect.value = estimacion.id;
                            updateEstimacionInfo();
                        }
                    })
                    .catch(error => console.error('Error cargando pedidos:', error));
            });
            
            // Escuchar cambios en el selector para actualizar información
            estimacionSelect.addEventListener('change', updateEstimacionInfo);
        }
        
        // Función para actualizar información de la estimación seleccionada
        function updateEstimacionInfo() {
            const estimacionId = document.getElementById('estimacion-id').value;
            const estimacionInfoDiv = document.getElementById('estimacion-info');
            
            if (!estimacionId) {
                estimacionInfoDiv.innerHTML = '';
                return;
            }
            
            const estimacion = estimacionesData.find(e => e.id == estimacionId);
            
            if (estimacion) {
                fetch('../../data/pedidos.json')
                    .then(response => response.json())
                    .then(pedidos => {
                        const pedido = pedidos.find(p => p.id === estimacion.pedidoId);
                        
                        if (pedido) {
                            fetch('../../data/contratos.json')
                                .then(response => response.json())
                                .then(contratos => {
                                    const contrato = contratos.find(c => c.id === pedido.contratoId);
                                    
estimacionInfoDiv.innerHTML = `
    <div class="alert alert-info">
        <h5>Información de la Estimación #${estimacion.id}</h5>
        <p><strong>Pedido:</strong> #${pedido.id}</p>
        <p><strong>Contrato:</strong> #${contrato ? contrato.id : 'N/A'}</p>
        <p><strong>Servicios Estimados:</strong> ${estimacion.serviciosEstimados.join(', ')}</p>
        <p><strong>Total Estimado:</strong> ${formatCurrency(estimacion.totalEstimado)}</p>
    </div>
    `;
                                })
                                .catch(error => console.error('Error cargando contratos:', error));
                        }
                    })
                    .catch(error => console.error('Error cargando pedidos:', error));
            }
        }
        
        // Función para cargar datos de la orden en modo edición
        function loadOrdenData(ordenId) {
            fetch('../../data/ordenes.json')
                .then(response => response.json())
                .then(ordenes => {
                    const orden = ordenes.find(o => o.id === ordenId);
                    
                    if (orden) {
                        document.getElementById('estimacion-id').value = orden.estimacionId;
                        updateEstimacionInfo();
                        
                        document.getElementById('periodo-liquidacion').value = orden.periodoLiquidacion;
                        document.getElementById('estado').value = orden.estado;
                        document.getElementById('listo-facturar').checked = orden.listoFacturar;
                    } else {
                        alert('No se encontró la orden de venta solicitada.');
                        window.location.href = 'ordenes.html';
                    }
                })
                .catch(error => console.error('Error cargando órdenes:', error));
        }
        
        // Función para configurar eventos del formulario
        function setupFormEvents() {
            // Envío del formulario
            document.getElementById('orden-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    saveOrden();
                }
            });
            
            // Botón de cancelar
            document.getElementById('cancel-button').addEventListener('click', function() {
                window.location.href = 'ordenes.html';
            });
        }
        
        // Función para validar el formulario
        function validateForm() {
            const estimacionId = document.getElementById('estimacion-id').value;
            const periodoLiquidacion = document.getElementById('periodo-liquidacion').value;
            
            if (!estimacionId) {
                alert('Debe seleccionar una estimación.');
                return false;
            }
            
            if (!periodoLiquidacion) {
                alert('Debe seleccionar un periodo de liquidación.');
                return false;
            }
            
            // Validar formato del periodo (YYYY-MM)
            const periodoRegex = /^\d{4}-\d{2}$/;
            if (!periodoRegex.test(periodoLiquidacion)) {
                alert('El periodo de liquidación debe tener el formato YYYY-MM.');
                return false;
            }
            
            return true;
        }
        
        // Función para guardar la orden
        function saveOrden() {
            // Recopilar datos del formulario
            const estimacionId = parseInt(document.getElementById('estimacion-id').value);
            const periodoLiquidacion = document.getElementById('periodo-liquidacion').value;
            const estado = document.getElementById('estado').value;
            const listoFacturar = document.getElementById('listo-facturar').checked;
            
            // Crear objeto de orden
            const orden = {
                estimacionId,
                periodoLiquidacion,
                estado,
                listoFacturar
            };
            
            // En una implementación real, aquí se enviarían los datos al backend
            // Por ahora, simulamos la persistencia con localStorage
            
            if (isEditMode) {
                orden.id = currentOrdenId;
                updateOrdenInStorage(orden);
            } else {
                saveNewOrdenToStorage(orden);
            }
            
            // Redireccionar a la lista de órdenes
            window.location.href = 'ordenes.html';
        }
        
        // Función para guardar nueva orden en localStorage
        function saveNewOrdenToStorage(orden) {
            fetch('../../data/ordenes.json')
                .then(response => response.json())
                .then(ordenes => {
                    // Generar nuevo ID
                    const newId = Math.max(...ordenes.map(o => o.id), 0) + 1;
                    orden.id = newId;
                    
                    // Agregar a la lista
                    ordenes.push(orden);
                    
                    // Guardar en localStorage
                    localStorage.setItem('mockOrdenes', JSON.stringify(ordenes));
                    
                    alert(`Orden de venta #${newId} creada correctamente.`);
                })
                .catch(error => console.error('Error guardando orden:', error));
        }
        
        // Función para actualizar orden en localStorage
        function updateOrdenInStorage(orden) {
            fetch('../../data/ordenes.json')
                .then(response => response.json())
                .then(ordenes => {
                    // Encontrar índice de la orden a actualizar
                    const index = ordenes.findIndex(o => o.id === orden.id);
                    
                    if (index !== -1) {
                        // Actualizar orden
                        ordenes[index] = orden;
                        
                        // Guardar en localStorage
                        localStorage.setItem('mockOrdenes', JSON.stringify(ordenes));
                        
                        alert(`Orden de venta #${orden.id} actualizada correctamente.`);
                    }
                })
                .catch(error => console.error('Error actualizando orden:', error));
        }
        
        // Función para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        }
    </script>
</head>
<body>
    <!-- Header Component -->
    <div id="header"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Component -->
            <div id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse"></div>
            
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 id="form-title" class="h2">Nueva Orden de Venta</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="ordenes.html" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver al Listado
                        </a>
                    </div>
                </div>
                
                <!-- Formulario de Orden de Venta -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-text"></i> Formulario de Orden de Venta
                    </div>
                    <div class="card-body">
                        <form id="orden-form">
                            <!-- Selección de Estimación -->
                            <div class="mb-3">
                                <label for="estimacion-id" class="form-label">Estimación</label>
                                <select id="estimacion-id" class="form-select" required>
                                    <option value="">Seleccione una estimación...</option>
                                    <!-- Opciones de estimaciones cargadas dinámicamente -->
                                </select>
                            </div>
                            
                            <!-- Información de la Estimación -->
                            <div id="estimacion-info" class="mb-3">
                                <!-- Información cargada dinámicamente -->
                            </div>
                            
                            <!-- Periodo de Liquidación -->
                            <div class="mb-3">
                                <label for="periodo-liquidacion" class="form-label">Periodo de Liquidación</label>
                                <input type="month" id="periodo-liquidacion" class="form-control" required>
                                <div class="form-text">Formato: YYYY-MM (Año-Mes)</div>
                            </div>
                            
                            <!-- Estado -->
                            <div class="mb-3">
                                <label for="estado" class="form-label">Estado</label>
                                <select id="estado" class="form-select" required>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Parcial">Parcial</option>
                                    <option value="Aceptada">Aceptada</option>
                                    <option value="Cancelada">Cancelada</option>
                                </select>
                            </div>
                            
                            <!-- Listo para Facturar -->
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="listo-facturar">
                                <label class="form-check-label" for="listo-facturar">Listo para Facturar</label>
                            </div>
                            
                            <!-- Botones de Acción -->
                            <div class="d-flex justify-content-end">
                                <button type="button" id="cancel-button" class="btn btn-secondary me-2">Cancelar</button>
                                <button type="submit" id="submit-button" class="btn btn-primary">Guardar Orden de Venta</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="card-footer text-muted">
                        <div class="alert alert-info mb-0">
                            <h5><i class="bi bi-info-circle"></i> Información importante</h5>
                            <p>Las órdenes de venta generadas a partir de estimaciones aprobadas son la base para la facturación posterior.</p>
                            <p>El periodo de liquidación es fundamental para el proceso de contabilidad y debe corresponder al mes en que se prestaron los servicios.</p>
                            <p>Marque "Listo para Facturar" solo cuando todos los entregables hayan sido validados y aceptados por el cliente.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Footer Component -->
    <div id="footer"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>