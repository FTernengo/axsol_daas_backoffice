<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXSOL DaaS - Formulario de Entregable</title>
    <link rel="stylesheet" href="./assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/css/styles.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Incluir sidebar -->
            <div class="col-md-3 col-lg-2 px-0 bg-light sidebar" id="sidebar-container"></div>
            
            <!-- Contenido principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <!-- Incluir header -->
                <div id="header-container"></div>
                
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="form-title">Nuevo Entregable</h1>
                </div>

                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="card">
                            <div class="card-body">
                                <form id="entregable-form" novalidate>
                                    <input type="hidden" id="entregable-id">
                                    
                                    <div class="mb-3">
                                        <label for="inspeccion" class="form-label">Inspección</label>
                                        <select class="form-select" id="inspeccion" required>
                                            <option value="">Seleccione una inspección</option>
                                        </select>
                                        <div class="invalid-feedback">
                                            Por favor seleccione una inspección.
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="orden" class="form-label">Orden de Venta (Opcional)</label>
                                        <select class="form-select" id="orden">
                                            <option value="">Sin orden de venta asociada</option>
                                        </select>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="tipo" class="form-label">Tipo de Entregable</label>
                                            <select class="form-select" id="tipo" required>
                                                <option value="">Seleccione un tipo</option>
                                                <option value="Ortofoto">Ortofoto</option>
                                                <option value="Nube de puntos">Nube de puntos</option>
                                                <option value="Malla 3D">Malla 3D</option>
                                                <option value="Informe">Informe</option>
                                                <option value="Video">Video</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un tipo de entregable.
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="estado" class="form-label">Estado</label>
                                            <select class="form-select" id="estado" required>
                                                <option value="">Seleccione un estado</option>
                                                <option value="Activo">Activo</option>
                                                <option value="Observado">Observado</option>
                                                <option value="Aceptado">Aceptado</option>
                                                <option value="Anulado">Anulado</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un estado.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="assetCesiumId" class="form-label">Asset Cesium ID</label>
                                            <input type="text" class="form-control" id="assetCesiumId" required>
                                            <div class="invalid-feedback">
                                                Por favor ingrese el identificador del asset en Cesium.
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="token" class="form-label">Token</label>
                                            <input type="text" class="form-control" id="token" required>
                                            <div class="invalid-feedback">
                                                Por favor ingrese el token de acceso.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fechaPublicacion" class="form-label">Fecha de Publicación</label>
                                            <input type="date" class="form-control" id="fechaPublicacion" required>
                                            <div class="invalid-feedback">
                                                Por favor seleccione una fecha de publicación válida.
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="validacionVencida">
                                                <label class="form-check-label" for="validacionVencida">
                                                    Validación vencida
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="versionAnterior" class="form-label">Versión Anterior (Opcional)</label>
                                        <select class="form-select" id="versionAnterior">
                                            <option value="">Sin versión anterior</option>
                                        </select>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end mt-4">
                                        <button type="button" class="btn btn-secondary me-2" id="btn-cancelar">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Incluir footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="./assets/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/js/main.js"></script>
    <script>
        // Cargar componentes
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar header, sidebar y footer
            fetch('/components/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                });
            
            fetch('/components/sidebar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    // Marcar como activo el ítem del menú
                    setTimeout(() => {
                        const menuItem = document.querySelector('.nav-link[href="./modules/inspecciones/entregables.html"]');
                        if (menuItem) menuItem.classList.add('active');
                    }, 100);
                });
            
            fetch('/components/footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                });
            
            // Inicializar la página
            cargarInspecciones();
            cargarOrdenes();
            
            // Establecer fecha actual por defecto
            const hoy = new Date();
            document.getElementById('fechaPublicacion').valueAsDate = hoy;
            
            // Verificar si estamos en modo edición
            const urlParams = new URLSearchParams(window.location.search);
            const entregableId = urlParams.get('id');
            const inspeccionId = urlParams.get('inspeccionId');
            
            if (entregableId) {
                document.getElementById('form-title').textContent = 'Editar Entregable';
                cargarEntregable(entregableId);
            } else if (inspeccionId) {
                // Si venimos desde una inspección específica, preseleccionarla
                setTimeout(() => {
                    document.getElementById('inspeccion').value = inspeccionId;
                    cargarVersionesAnteriores(inspeccionId);
                }, 500);
            }
            
            // Event listeners
            document.getElementById('entregable-form').addEventListener('submit', guardarEntregable);
            document.getElementById('btn-cancelar').addEventListener('click', function() {
                window.location.href = '/modules/inspecciones/entregables.html';
            });
            
            // Al cambiar la inspección, cargar las versiones anteriores posibles
            document.getElementById('inspeccion').addEventListener('change', function() {
                const inspeccionId = this.value;
                if (inspeccionId) {
                    cargarVersionesAnteriores(inspeccionId);
                } else {
                    // Limpiar el selector de versiones anteriores
                    const selectVersionAnterior = document.getElementById('versionAnterior');
                    selectVersionAnterior.innerHTML = '<option value="">Sin versión anterior</option>';
                }
            });
        });
        
        // Función para cargar inspecciones en el select
        async function cargarInspecciones() {
            try {
                const [inspeccionesResponse, activosResponse] = await Promise.all([
                    fetch('/data/inspecciones.json'),
                    fetch('/data/activos.json')
                ]);
                
                const inspecciones = await inspeccionesResponse.json();
                const activos = await activosResponse.json();
                
                // Mapear activos por ID para fácil acceso
                const activosMap = activos.reduce((map, activo) => {
                    map[activo.id] = activo;
                    return map;
                }, {});
                
                const selectInspeccion = document.getElementById('inspeccion');
                inspecciones.forEach(inspeccion => {
                    const activo = activosMap[inspeccion.activoId] || { nombre: 'Desconocido' };
                    const option = document.createElement('option');
                    option.value = inspeccion.id;
                    
                    const fecha = new Date(inspeccion.fecha);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES');
                    
                    option.textContent = `ID: ${inspeccion.id} - ${activo.nombre} (${fechaFormateada}) - ${inspeccion.tipo}`;
                    selectInspeccion.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar inspecciones:', error);
                mostrarAlerta('No se pudieron cargar las inspecciones', 'danger');
            }
        }
        
        // Función para cargar órdenes de venta en el select
        async function cargarOrdenes() {
            try {
                const response = await fetch('/data/ordenes.json');
                const ordenes = await response.json();
                
                const selectOrden = document.getElementById('orden');
                ordenes.forEach(orden => {
                    const option = document.createElement('option');
                    option.value = orden.id;
                    option.textContent = `ID: ${orden.id} - ${orden.referencia || 'Sin referencia'}`;
                    selectOrden.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar órdenes de venta:', error);
                mostrarAlerta('No se pudieron cargar las órdenes de venta', 'danger');
            }
        }
        
        // Función para cargar versiones anteriores para una inspección
        async function cargarVersionesAnteriores(inspeccionId) {
            try {
                const response = await fetch('/data/entregables.json');
                const entregables = await response.json();
                
                // Filtrar entregables de la misma inspección
                const entregablesInspeccion = entregables.filter(e => e.inspeccionId == inspeccionId);
                
                const selectVersionAnterior = document.getElementById('versionAnterior');
                selectVersionAnterior.innerHTML = '<option value="">Sin versión anterior</option>';
                
                entregablesInspeccion.forEach(entregable => {
                    const option = document.createElement('option');
                    option.value = entregable.id;
                    
                    const fecha = new Date(entregable.fechaPublicacion);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES');
                    
                    option.textContent = `ID: ${entregable.id} - ${entregable.tipo} (${fechaFormateada})`;
                    selectVersionAnterior.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar versiones anteriores:', error);
                mostrarAlerta('No se pudieron cargar las versiones anteriores', 'danger');
            }
        }
        
        // Función para cargar un entregable existente
        async function cargarEntregable(id) {
            try {
                const response = await fetch('/data/entregables.json');
                const entregables = await response.json();
                
                const entregable = entregables.find(e => e.id == id);
                
                if (!entregable) {
                    mostrarAlerta('No se encontró el entregable solicitado', 'warning');
                    return;
                }
                
                document.getElementById('entregable-id').value = entregable.id;
                document.getElementById('inspeccion').value = entregable.inspeccionId;
                
                if (entregable.ordenId) {
                    document.getElementById('orden').value = entregable.ordenId;
                }
                
                document.getElementById('tipo').value = entregable.tipo;
                document.getElementById('estado').value = entregable.estado;
                document.getElementById('assetCesiumId').value = entregable.assetCesiumId;
                document.getElementById('token').value = entregable.token;
                document.getElementById('fechaPublicacion').value = entregable.fechaPublicacion; // Asumiendo formato ISO (YYYY-MM-DD)
                document.getElementById('validacionVencida').checked = entregable.validacionVencida;
                
                if (entregable.versionAnteriorId) {
                    // Cargar versiones anteriores y luego seleccionar la correcta
                    await cargarVersionesAnteriores(entregable.inspeccionId);
                    document.getElementById('versionAnterior').value = entregable.versionAnteriorId;
                } else {
                    await cargarVersionesAnteriores(entregable.inspeccionId);
                }
            } catch (error) {
                console.error('Error al cargar entregable:', error);
                mostrarAlerta('No se pudo cargar la información del entregable', 'danger');
            }
        }
        
        // Función para guardar entregable
        async function guardarEntregable(event) {
            event.preventDefault();
            
            // Validar el formulario
            const form = document.getElementById('entregable-form');
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            try {
                const entregableId = document.getElementById('entregable-id').value;
                const inspeccionId = document.getElementById('inspeccion').value;
                const ordenId = document.getElementById('orden').value || null;
                const tipo = document.getElementById('tipo').value;
                const estado = document.getElementById('estado').value;
                const assetCesiumId = document.getElementById('assetCesiumId').value;
                const token = document.getElementById('token').value;
                const fechaPublicacion = document.getElementById('fechaPublicacion').value;
                const validacionVencida = document.getElementById('validacionVencida').checked;
                const versionAnteriorId = document.getElementById('versionAnterior').value || null;
                
                // Obtener entregables existentes
                const response = await fetch('/data/entregables.json');
                let entregables = await response.json();
                
                // Crear o actualizar entregable
                if (entregableId) {
                    // Actualizar existente
                    const index = entregables.findIndex(e => e.id == entregableId);
                    if (index !== -1) {
                        entregables[index] = {
                            id: parseInt(entregableId),
                            inspeccionId: parseInt(inspeccionId),
                            ordenId: ordenId ? parseInt(ordenId) : null,
                            tipo,
                            assetCesiumId,
                            token,
                            estado,
                            fechaPublicacion,
                            validacionVencida,
                            versionAnteriorId: versionAnteriorId ? parseInt(versionAnteriorId) : null
                        };
                    }
                } else {
                    // Crear nuevo
                    const nuevoId = entregables.length > 0 ? Math.max(...entregables.map(e => e.id)) + 1 : 1;
                    entregables.push({
                        id: nuevoId,
                        inspeccionId: parseInt(inspeccionId),
                        ordenId: ordenId ? parseInt(ordenId) : null,
                        tipo,
                        assetCesiumId,
                        token,
                        estado,
                        fechaPublicacion,
                        validacionVencida,
                        versionAnteriorId: versionAnteriorId ? parseInt(versionAnteriorId) : null
                    });
                }
                
                // En un entorno real, aquí iría la llamada a la API
                // Simulamos con localStorage para este ejercicio
                localStorage.setItem('entregables', JSON.stringify(entregables));
                
                // Mostrar mensaje y redireccionar
                mostrarAlerta('Entregable guardado correctamente', 'success');
                setTimeout(() => {
                    window.location.href = '/modules/inspecciones/entregables.html';
                }, 1500);
            } catch (error) {
                console.error('Error al guardar entregable:', error);
                mostrarAlerta('Error al guardar el entregable', 'danger');
            }
        }
        
        // Función para mostrar alertas
        function mostrarAlerta(mensaje, tipo) {
            const alertPlaceholder = document.createElement('div');
            alertPlaceholder.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertPlaceholder.role = 'alert';
            alertPlaceholder.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertPlaceholder);
            
            // Auto cerrar después de 5 segundos
            setTimeout(() => {
                alertPlaceholder.remove();
            }, 5000);
        }
    </script>
</body>
</html>