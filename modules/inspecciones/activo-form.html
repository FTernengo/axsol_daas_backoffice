<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXSOL DaaS - Formulario de Activo</title>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/styles.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Incluir sidebar -->
            <div class="col-md-3 col-lg-2 px-0 bg-light sidebar" id="sidebar-container"></div>
            
            <!-- Contenido principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <!-- Incluir header -->
                <div id="header-container"></div>
                
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="form-title">Nuevo Activo</h1>
                </div>

                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="card">
                            <div class="card-body">
                                <form id="activo-form" novalidate>
                                    <input type="hidden" id="activo-id">
                                    
                                    <div class="mb-3">
                                        <label for="proyecto" class="form-label">Proyecto</label>
                                        <select class="form-select" id="proyecto" required>
                                            <option value="">Seleccione un proyecto</option>
                                        </select>
                                        <div class="invalid-feedback">
                                            Por favor seleccione un proyecto.
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="nombre" class="form-label">Nombre del Activo</label>
                                        <input type="text" class="form-control" id="nombre" required>
                                        <div class="invalid-feedback">
                                            Por favor ingrese un nombre para el activo.
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="tipo-activo" class="form-label">Tipo de Activo</label>
                                            <select class="form-select" id="tipo-activo" required>
                                                <option value="">Seleccione un tipo</option>
                                                <option value="Planta">Planta</option>
                                                <option value="Equipo">Equipo</option>
                                                <option value="Estructura">Estructura</option>
                                                <option value="Tubería">Tubería</option>
                                                <option value="Torre">Torre</option>
                                                <option value="Otro">Otro</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un tipo de activo.
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="sector-integridad" class="form-label">Sector de Integridad</label>
                                            <select class="form-select" id="sector-integridad" required>
                                                <option value="">Seleccione un sector</option>
                                                <option value="Crítico">Crítico</option>
                                                <option value="Medio">Medio</option>
                                                <option value="Bajo">Bajo</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un sector de integridad.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end mt-4">
                                        <button type="button" class="btn btn-secondary me-2" id="btn-cancelar">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Incluir footer -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="../../assets/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script>
        // Cargar componentes
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar header, sidebar y footer
            fetch('../../components/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                });
            
            fetch('/components/sidebar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    // Marcar como activo el ítem del menú
                    setTimeout(() => {
                        const menuItem = document.querySelector('.nav-link[href="./modules/inspecciones/activos.html"]');
                        if (menuItem) menuItem.classList.add('active');
                    }, 100);
                });
            
            fetch('/components/footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer-container').innerHTML = data;
                });
            
            // Inicializar la página
            cargarProyectos();
            
            // Verificar si estamos en modo edición
            const urlParams = new URLSearchParams(window.location.search);
            const activoId = urlParams.get('id');
            
            if (activoId) {
                document.getElementById('form-title').textContent = 'Editar Activo';
                cargarActivo(activoId);
            }
            
            // Event listeners
            document.getElementById('activo-form').addEventListener('submit', guardarActivo);
            document.getElementById('btn-cancelar').addEventListener('click', function() {
                window.location.href = '/modules/inspecciones/activos.html';
            });
        });
        
        // Función para cargar proyectos en el select
        async function cargarProyectos() {
            try {
                const response = await fetch('/data/proyectos.json');
                const proyectos = await response.json();
                
                const selectProyecto = document.getElementById('proyecto');
                proyectos.forEach(proyecto => {
                    const option = document.createElement('option');
                    option.value = proyecto.id;
                    option.textContent = proyecto.nombre;
                    selectProyecto.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar proyectos:', error);
                mostrarAlerta('No se pudieron cargar los proyectos', 'danger');
            }
        }
        
        // Función para cargar un activo existente
        async function cargarActivo(id) {
            try {
                const response = await fetch('/data/activos.json');
                const activos = await response.json();
                
                const activo = activos.find(a => a.id == id);
                
                if (!activo) {
                    mostrarAlerta('No se encontró el activo solicitado', 'warning');
                    return;
                }
                
                document.getElementById('activo-id').value = activo.id;
                document.getElementById('proyecto').value = activo.proyectoId;
                document.getElementById('nombre').value = activo.nombre;
                document.getElementById('tipo-activo').value = activo.tipoActivo;
                document.getElementById('sector-integridad').value = activo.sectorIntegridad;
            } catch (error) {
                console.error('Error al cargar activo:', error);
                mostrarAlerta('No se pudo cargar la información del activo', 'danger');
            }
        }
        
        // Función para guardar activo
        async function guardarActivo(event) {
            event.preventDefault();
            
            // Validar el formulario
            const form = document.getElementById('activo-form');
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            try {
                const activoId = document.getElementById('activo-id').value;
                const proyectoId = document.getElementById('proyecto').value;
                const nombre = document.getElementById('nombre').value;
                const tipoActivo = document.getElementById('tipo-activo').value;
                const sectorIntegridad = document.getElementById('sector-integridad').value;
                
                // Obtener activos existentes
                const response = await fetch('/data/activos.json');
                let activos = await response.json();
                
                // Crear o actualizar activo
                if (activoId) {
                    // Actualizar existente
                    const index = activos.findIndex(a => a.id == activoId);
                    if (index !== -1) {
                        activos[index] = {
                            id: parseInt(activoId),
                            proyectoId: parseInt(proyectoId),
                            nombre,
                            tipoActivo,
                            sectorIntegridad
                        };
                    }
                } else {
                    // Crear nuevo
                    const nuevoId = activos.length > 0 ? Math.max(...activos.map(a => a.id)) + 1 : 1;
                    activos.push({
                        id: nuevoId,
                        proyectoId: parseInt(proyectoId),
                        nombre,
                        tipoActivo,
                        sectorIntegridad
                    });
                }
                
                // En un entorno real, aquí iría la llamada a la API
                // Simulamos con localStorage para este ejercicio
                localStorage.setItem('activos', JSON.stringify(activos));
                
                // Mostrar mensaje y redireccionar
                mostrarAlerta('Activo guardado correctamente', 'success');
                setTimeout(() => {
                    window.location.href = '/modules/inspecciones/activos.html';
                }, 1500);
            } catch (error) {
                console.error('Error al guardar activo:', error);
                mostrarAlerta('Error al guardar el activo', 'danger');
            }
        }
        
        // Función para mostrar alertas
        function mostrarAlerta(mensaje, tipo) {
            const alertPlaceholder = document.createElement('div');
            alertPlaceholder.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alertPlaceholder.role = 'alert';
            alertPlaceholder.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertPlaceholder);
            
            // Auto cerrar después de 5 segundos
            setTimeout(() => {
                alertPlaceholder.remove();
            }, 5000);
        }
    </script>
</body>
</html>