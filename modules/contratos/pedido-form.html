<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXSOL DaaS - Formulario de Pedido</title>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- DatePicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div id="sidebar-container"></div>
            
            <!-- Contenido principal -->
            <main class="col px-0 flex-grow-1">
                <div id="header-container"></div>
                
                <div class="container-fluid py-4">
                    <div class="row justify-content-center">
                        <div class="col-12 col-lg-10">
                            <div class="card shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0" id="formTitle">Nuevo Pedido</h5>
                                </div>
                                <div class="card-body">
                                    <form id="pedidoForm" class="needs-validation" novalidate>
                                        <input type="hidden" id="pedidoId">
                                        
                                        <!-- Contrato -->
                                        <div class="mb-3">
                                            <label for="contratoId" class="form-label">Contrato</label>
                                            <select class="form-select" id="contratoId" required>
                                                <option value="">Seleccionar contrato</option>
                                                <!-- Se cargará dinámicamente -->
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un contrato.
                                            </div>
                                        </div>
                                        
                                        <!-- Información del Contrato -->
                                        <div class="alert alert-info mb-3" id="infoContrato" style="display: none;">
                                            <!-- Se cargará dinámicamente -->
                                        </div>
                                        
                                        <!-- Proyecto (autocompletado del contrato) -->
                                        <div class="mb-3">
                                            <label for="proyectoId" class="form-label">Proyecto</label>
                                            <input type="text" class="form-control" id="proyectoNombre" readonly>
                                            <input type="hidden" id="proyectoId">
                                        </div>
                                        
                                        <!-- Fecha -->
                                        <div class="mb-3">
                                            <label for="fecha" class="form-label">Fecha</label>
                                            <input type="text" class="form-control flatpickr-date" id="fecha" required>
                                            <div class="invalid-feedback">
                                                Por favor seleccione una fecha.
                                            </div>
                                        </div>
                                        
                                        <!-- Estado -->
                                        <div class="mb-4">
                                            <label for="estado" class="form-label">Estado</label>
                                            <select class="form-select" id="estado" required>
                                                <option value="">Seleccionar estado</option>
                                                <option value="Planificado">Planificado</option>
                                                <option value="En Progreso">En Progreso</option>
                                                <option value="Completado">Completado</option>
                                                <option value="Cancelado">Cancelado</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un estado.
                                            </div>
                                        </div>
                                        
                                        <!-- Botones de acción -->
                                        <div class="d-flex justify-content-end gap-2">
                                            <button type="button" class="btn btn-secondary" onclick="window.location.href='pedidos.html'">
                                                <i class="bi bi-x-circle me-1"></i> Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-save me-1"></i> Guardar
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../../assets/js/bootstrap.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/mock-data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        // Variables globales
        let contratos = [];
        let proyectos = [];
        let clientes = [];
        
        // Cargar componentes
        document.addEventListener("DOMContentLoaded", function() {
            // Cargar sidebar y header
            fetch('../../components/sidebar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    // Activar item del menú
                    const menuItem = document.querySelector('#sidebar-contratos');
                    if (menuItem) menuItem.classList.add('active');
                });
            
            fetch('../../components/header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                });
            
            // Inicializar flatpickr para fechas
            flatpickr(".flatpickr-date", {
                dateFormat: "Y-m-d",
                allowInput: true
            });
            
            // Cargar datos iniciales
            cargarDatos();
            
            // Enlazar eventos
            document.getElementById('contratoId').addEventListener('change', actualizarInfoContrato);
            document.getElementById('pedidoForm').addEventListener('submit', guardarPedido);
        });
        
        // Función para cargar todos los datos necesarios
        function cargarDatos() {
            Promise.all([
                fetch('../../data/contratos.json').then(response => response.json()),
                fetch('../../data/proyectos.json').then(response => response.json()),
                fetch('../../data/clientes.json').then(response => response.json())
            ])
            .then(([contratosData, proyectosData, clientesData]) => {
                contratos = contratosData;
                proyectos = proyectosData;
                clientes = clientesData;
                
                // Cargar contratos en el select
                const selectContrato = document.getElementById('contratoId');
                contratos.forEach(contrato => {
                    const option = document.createElement('option');
                    option.value = contrato.id;
                    
                    // Buscar proyecto relacionado para mostrar info
                    const proyecto = proyectos.find(p => p.id === contrato.proyectoId) || { nombre: 'Desconocido' };
                    
                    option.textContent = `Contrato #${contrato.id} - ${proyecto.nombre}`;
                    selectContrato.appendChild(option);
                });
                
                // Comprobar modo edición
                comprobarEdicion();
            })
            .catch(error => console.error('Error cargando datos:', error));
        }
        
        // Función para actualizar información del contrato seleccionado
        function actualizarInfoContrato() {
            const contratoId = parseInt(document.getElementById('contratoId').value);
            const infoContrato = document.getElementById('infoContrato');
            
            if (!contratoId) {
                infoContrato.style.display = 'none';
                document.getElementById('proyectoNombre').value = '';
                document.getElementById('proyectoId').value = '';
                return;
            }
            
            const contrato = contratos.find(c => c.id === contratoId);
            if (!contrato) return;
            
            // Buscar proyecto y cliente relacionados
            const proyecto = proyectos.find(p => p.id === contrato.proyectoId) || { nombre: 'Desconocido' };
            const cliente = clientes.find(c => c.id === contrato.clienteId) || { nombre: 'Desconocido' };
            
            // Actualizar información visible
            infoContrato.innerHTML = `
                <p class="mb-0"><strong>Cliente:</strong> ${cliente.nombre}</p>
                <p class="mb-0"><strong>Tipo de Servicio:</strong> ${contrato.tipoServicio}</p>
                <p class="mb-0"><strong>Frecuencia:</strong> ${contrato.frecuencia}</p>
                <p class="mb-0"><strong>Vigencia:</strong> ${new Date(contrato.fechaInicio).toLocaleDateString()} a ${new Date(contrato.fechaFin).toLocaleDateString()}</p>
            `;
            infoContrato.style.display = 'block';
            
            // Actualizar proyecto (automáticamente del contrato)
            document.getElementById('proyectoNombre').value = proyecto.nombre;
            document.getElementById('proyectoId').value = proyecto.id;
        }
        
        // Comprobar si estamos en modo edición
        function comprobarEdicion() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            
            if (id) {
                // Estamos en modo edición
                document.getElementById('formTitle').textContent = 'Editar Pedido';
                document.getElementById('pedidoId').value = id;
                
                // Cargar datos del pedido
                fetch('../../data/pedidos.json')
                    .then(response => response.json())
                    .then(pedidos => {
                        const pedido = pedidos.find(p => p.id === parseInt(id));
                        if (!pedido) {
                            alert('Pedido no encontrado');
                            window.location.href = 'pedidos.html';
                            return;
                        }
                        
                        // Completar el formulario con los datos
                        document.getElementById('contratoId').value = pedido.contratoId;
                        actualizarInfoContrato(); // Actualizar info relacionada
                        document.getElementById('fecha').value = pedido.fecha;
                        document.getElementById('estado').value = pedido.estado;
                    })
                    .catch(error => console.error('Error cargando pedido:', error));
            }
        }
        
        // Guardar pedido
        function guardarPedido(event) {
            event.preventDefault();
            
            // Validar formulario
            const form = document.getElementById('pedidoForm');
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // Obtener valores
            const id = document.getElementById('pedidoId').value;
            const contratoId = parseInt(document.getElementById('contratoId').value);
            const proyectoId = parseInt(document.getElementById('proyectoId').value);
            const fecha = document.getElementById('fecha').value;
            const estado = document.getElementById('estado').value;
            
            // Crear objeto de pedido
            const pedido = {
                contratoId,
                proyectoId,
                fecha,
                estado
            };
            
            // En un sistema real, esto sería una petición POST o PUT a la API
            // Para el mockup, simulamos con localStorage
            fetch('../../data/pedidos.json')
                .then(response => response.json())
                .then(pedidos => {
                    if (id) {
                        // Modo edición
                        const index = pedidos.findIndex(p => p.id === parseInt(id));
                        if (index !== -1) {
                            // Mantener el ID original
                            pedido.id = parseInt(id);
                            pedidos[index] = pedido;
                        }
                    } else {
                        // Modo creación
                        // Encontrar el ID más alto y agregar 1
                        const maxId = pedidos.reduce((max, p) => (p.id > max ? p.id : max), 0);
                        pedido.id = maxId + 1;
                        pedidos.push(pedido);
                    }
                    
                    // En un sistema real no haríamos esto, usaríamos una API
                    // Esto es solo para simular la persistencia en el frontend
                    localStorage.setItem('pedidos', JSON.stringify(pedidos));
                    
                    // Redirigir a la lista
                    window.location.href = 'pedidos.html';
                })
                .catch(error => {
                    console.error('Error guardando pedido:', error);
                    alert('Ocurrió un error al guardar. Intente nuevamente.');
                });
        }
    </script>
</body>
</html>